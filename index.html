<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HOD Attendance Portal</title>
  <style>
    body {font-family:Arial, sans-serif; margin:20px;}
    h2 {color:#333;}
    #studentsList label {display:block; margin:4px 0;}
    button {margin-top:10px; padding:6px 12px;}
  </style>
</head>
<body>

<h2>HOD Attendance</h2>

<label>Year:
  <select id="year">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
  </select>
</label>

<button onclick="loadStudents()">Load Students</button>

<div id="studentsList"></div>

<button onclick="saveAttendance()">Save Attendance</button>

<p id="msg"></p>

<script>
// === REPLACE WITH YOUR SCRIPT URL ===
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzX35p2lWwIPw36dLT2NPTl-el8NsRPPBqptCPrrvbk34BxjJhc_WCNpvhZeJzU3tty/exec";

// dept is passed from MIT App after login:  index.html?dept=CSM
const params = new URLSearchParams(window.location.search);
const dept = params.get("dept") || "";

async function loadStudents(){
  const yr = document.getElementById('year').value;
  const url = `${WEBAPP_URL}?action=getStudents&dept=${encodeURIComponent(dept)}&year=${encodeURIComponent(yr)}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.success) return alert(data.message);
    document.getElementById('studentsList').innerHTML =
      data.students.map(s =>
        `<label><input type="checkbox" value="${s.rollno}"> ${s.rollno}</label>`
      ).join("");
  } catch(err){
    alert("Error loading students: " + err);
  }
}

async function saveAttendance(){
  const date = new Date().toISOString().split('T')[0];
  const yr = document.getElementById('year').value;
  const abs = [...document.querySelectorAll('#studentsList input:checked')]
               .map(c => c.value)
               .join(',');
  const url = `${WEBAPP_URL}?action=saveAttendance&dept=${encodeURIComponent(dept)}&year=${encodeURIComponent(yr)}&date=${encodeURIComponent(date)}&absentees=${encodeURIComponent(abs)}`;
  try {
    const res = await fetch(url);
    const j = await res.json();
    document.getElementById('msg').innerText = j.message || j.error;
  } catch(err){
    alert("Error saving attendance: " + err);
  }
}
</script>

</body>
</html>
