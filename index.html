<!DOCTYPE html>
<html>
<head>
  <title>HOD Attendance Portal</title>
</head>
<body>
  <h2>Attendance Portal</h2>

  <label for="yearSelect">Select Year:</label>
  <select id="yearSelect">
    <option value="">--Select--</option>
    <option value="1">1st Year</option>
    <option value="2">2nd Year</option>
    <option value="3">3rd Year</option>
    <option value="4">4th Year</option>
  </select>

  <br><br>
  <button onclick="loadStudents()">Load Students</button>
  <ul id="studentsList"></ul>

  <br>
  <button onclick="saveAttendance()">Save Attendance</button>

  <script>
    // ✅ Your Apps Script Web App URL
    const API_URL = "https://script.google.com/macros/s/AKfycbz3nMfnMzZd4N9KS5LcTa9FuBtzFQstDazzMyOpx3TzK5L5I3RA5oEQvxJ4vzdEGgSV/exec";
    
    // ✅ dept comes from login (example: ?dept=CSM)
    const DEPT = new URLSearchParams(window.location.search).get("dept"); 

    // ==============================
    // Load Students
    // ==============================
    async function loadStudents() {
      const year = document.getElementById("yearSelect").value;
      if (!year) return alert("Select a year first!");

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "getStudents",
            dept: DEPT,
            year
          })
        });

        const result = await response.json();
        console.log("Students Response:", result);

        if (result.students && Array.isArray(result.students)) {
          let html = "";
          result.students.forEach(s => {
            html += `<li>
              <input type="checkbox" class="studentBox" value="${s.roll}">
              ${s.roll} - ${s.name}
            </li>`;
          });
          document.getElementById("studentsList").innerHTML = html;
        } else {
          alert("No students found for this dept/year!");
        }
      } catch (err) {
        alert("Error loading students: " + err);
      }
    }

    // ==============================
    // Save Attendance
    // ==============================
    async function saveAttendance() {
      const year = document.getElementById("yearSelect").value;
      if (!year) return alert("Select a year first!");

      const absentees = [];
      document.querySelectorAll(".studentBox").forEach(box => {
        if (!box.checked) absentees.push(box.value);
      });

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "saveAttendance",
            dept: DEPT,
            year,
            absentees
          })
        });

        const result = await response.json();
        alert(result.message || "Attendance saved!");
      } catch (err) {
        alert("Error saving: " + err);
      }
    }
  </script>
</body>
</html>
