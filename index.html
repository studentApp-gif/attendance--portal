<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SVCE Student Attendance Portal</title>

<style>
body{margin:0;font-family:Arial;background:#f2f4f8;}
.header{background:#003f6b;color:white;padding:15px;text-align:center;font-size:20px;font-weight:bold;}
.container{max-width:900px;margin:30px auto;background:white;padding:30px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
label{font-weight:bold;margin-top:10px;display:block;color:#003f6b;}
select,input{width:100%;padding:10px;margin:8px 0 15px;border-radius:6px;border:1px solid #ccc;}
button{padding:12px;border:none;border-radius:6px;cursor:pointer;font-size:15px;}
.primary-btn{background:#005c99;color:white;}
.primary-btn:hover{background:#003f6b;}
.save-btn{background:#00796b;color:white;}
.save-btn:hover{background:#004d40;}
.center-btn{width:60%;margin:10px auto;display:block;}
.card{border:1px solid #e0e0e0;padding:15px;margin:12px 0;border-radius:10px;background:#ffffff;}
.status-PENDING{color:#ff9800;font-weight:600;}
.status-APPROVED{color:#2e7d32;font-weight:600;}
.status-REJECTED{color:#c62828;font-weight:600;}
@media(max-width:768px){.center-btn{width:100%;}}
</style>

</head>
<body>

<div class="header">
SVCE Student Attendance Portal
</div>

<div class="container">

<label>Select Year / Branch</label>
<select id="yearSelect"></select>

<label>Session</label>
<select id="session">
<option value="Morning">Morning</option>
<option value="Afternoon">Afternoon</option>
</select>

<button class="primary-btn center-btn" onclick="prepareAttendance()">Load</button>

<div id="attendanceForm"></div>

<button id="saveBtn" class="save-btn center-btn" onclick="submitAttendance()" disabled>
Save Attendance
</button>

<p id="msg"></p>

<hr>

<h3>Today's Student Requests <span id="reqCount">0</span></h3>

<input placeholder="Search Roll No..." id="searchBox" onkeyup="filterRequests()">
<div id="requestsContainer"></div>

</div>

<script>

const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwnwn20CSLQrT55Kfyw_CoBM2PipoNMzbEPpVDocuMBF1zn81LLuEYNxuS0-X95XU5t/exec";
const dept=new URLSearchParams(window.location.search).get("dept") || "CSM";

let requestCache=[];
let fullRequestCache=[];

/* ===== LOAD DROPDOWN ===== */
function loadDropdown(){
const dropdown=document.getElementById("yearSelect");
if(dept==="HS"){
dropdown.innerHTML=`
<option value="HS-CSM|1">1st Year CSM</option>
<option value="HS-CSE|1">1st Year CSE</option>
<option value="HS-ECE|1">1st Year ECE</option>`;
}else{
dropdown.innerHTML=`
<option value="2">2nd Year</option>
<option value="3">3rd Year</option>
<option value="4">4th Year</option>`;
}}
loadDropdown();

/* ===== PREPARE ATTENDANCE (NO STUDENT LIST) ===== */
function prepareAttendance(){

document.getElementById("attendanceForm").innerHTML=`
<label>Present Boys</label>
<input type="number" id="boysPresent" value="0" min="0">

<label>Present Girls</label>
<input type="number" id="girlsPresent" value="0" min="0">
`;

document.getElementById("saveBtn").disabled=false;

loadRequests(true);
msg("");
}

/* ===== SAVE ATTENDANCE (NO DATE SENT) ===== */
async function submitAttendance(){

const selected=document.getElementById("yearSelect").value;
let finalDept=dept;
let finalYear=selected;

if(dept==="HS"){
const parts=selected.split("|");
finalDept=parts[0];
finalYear=parts[1];
}

const session=document.getElementById("session").value;
const boys=document.getElementById("boysPresent").value || 0;
const girls=document.getElementById("girlsPresent").value || 0;

const url=`${SCRIPT_URL}?action=saveAttendancePresent
&dept=${encodeURIComponent(finalDept)}
&year=${encodeURIComponent(finalYear)}
&session=${encodeURIComponent(session)}
&boysPresent=${boys}
&girlsPresent=${girls}`;

try{
const res=await fetch(url);
const json=await res.json();
msg(json.message);
document.getElementById("saveBtn").disabled=true;
}catch(e){
msg("Server Error");
}
}

/* ===== LOAD TODAY REQUESTS (NO DATE SENT) ===== */
async function loadRequests(silent=false){

const selected=document.getElementById("yearSelect").value;
let finalDept=dept;
let finalYear=selected;

if(dept==="HS"){
const parts=selected.split("|");
finalDept=parts[0];
finalYear=parts[1];
}

try{
const res=await fetch(`${SCRIPT_URL}?action=getLeaveRequestsForHOD
&dept=${encodeURIComponent(finalDept)}
&year=${encodeURIComponent(finalYear)}`);

const json=await res.json();
if(!json.success) return;

fullRequestCache=json.requests;
requestCache=[...fullRequestCache];

document.getElementById("reqCount").innerText=requestCache.length;
renderRequests();

if(!silent) msg("");

}catch(e){
msg("Error loading requests");
}
}

/* ===== RENDER REQUESTS ===== */
function renderRequests(){
const div=document.getElementById("requestsContainer");
div.innerHTML="";

requestCache.forEach(r=>{
div.innerHTML+=`
<div class="card">
<b>${r.roll}</b> | ${r.date}<br>
Reason: ${r.reason}<br>
Message: ${r.message}<br>
Status:<span class="status-${r.status}"> ${r.status}</span>
</div>`;
});
}

/* ===== SEARCH ===== */
function filterRequests(){
const q=document.getElementById("searchBox").value.toLowerCase();
requestCache=fullRequestCache.filter(r=>r.roll.toLowerCase().includes(q));
renderRequests();
}

function msg(t){ document.getElementById("msg").innerText=t; }

</script>

</body>
</html>
