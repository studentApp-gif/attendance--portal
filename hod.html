<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HOD Attendance Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f5f5f5;}
    h1 { color:#333; }
    .controls { margin-bottom:20px; }
    table { width:100%; border-collapse:collapse; margin-top:20px;}
    th, td { border:1px solid #ccc; padding:8px; text-align:left;}
    th { background:#eee;}
    button { padding:8px 16px; margin-top:15px; cursor:pointer;}
    .leave { color:green; font-weight:bold; }
    .no-leave { color:red; font-weight:bold; }
  </style>
</head>
<body>
  <h1>HOD Attendance Dashboard</h1>
  <div id="welcome"></div>

  <div class="controls">
    <label for="year">Select Year:</label>
    <select id="year">
      <option value="">-- Choose Year --</option>
      <option value="1">1st Year</option>
      <option value="2">2nd Year</option>
      <option value="3">3rd Year</option>
      <option value="4">4th Year</option>
    </select>
    <button id="loadBtn">Load Students</button>
  </div>

  <div id="tableContainer"></div>

  <button id="saveBtn" style="display:none;">Save Attendance</button>
  <div id="status"></div>

  <script>
    // ===== CONFIG =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz3nMfnMzZd4N9KS5LcTa9FuBtzFQstDazzMyOpx3TzK5L5I3RA5oEQvxJ4vzdEGgSV/exec";

    // ===== Parse query parameters (dept & email) =====
    const params = new URLSearchParams(window.location.search);
    const dept  = params.get('dept');
    //const email = params.get('email');
    document.getElementById('welcome').innerHTML = `<b>Department:</b> ${dept} <br><b>HOD:</b> ${email}`;

    const yearSel   = document.getElementById('year');
    const loadBtn   = document.getElementById('loadBtn');
    const saveBtn   = document.getElementById('saveBtn');
    const tableDiv  = document.getElementById('tableContainer');
    const statusDiv = document.getElementById('status');

    let students = [];

    // ===== Load students list =====
    loadBtn.addEventListener('click', () => {
      const year = yearSel.value;
      if (!year) { alert("Choose a Year first!"); return; }

      statusDiv.innerHTML = "Loading students...";
      fetch(`${SCRIPT_URL}?action=getStudents&dept=${dept}&year=${year}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            students = data.students;
            renderTable(students);
            saveBtn.style.display = "inline-block";
            statusDiv.innerHTML = "";
          } else {
            statusDiv.innerHTML = "Error: " + data.message;
          }
        })
        .catch(err => statusDiv.innerHTML = "Error: " + err);
    });

    // ===== Render student table with checkboxes =====
    function renderTable(list) {
      if (!list.length) {
        tableDiv.innerHTML = "<p>No students found for this year.</p>";
        return;
      }

      let html = "<table><thead><tr><th>Roll No</th><th>Email</th><th>Absent?</th></tr></thead><tbody>";
      list.forEach(st => {
        html += `<tr>
          <td>${st.rollno}</td>
          <td>${st.email}</td>
          <td><input type="checkbox" class="absent" value="${st.rollno}"></td>
        </tr>`;
      });
      html += "</tbody></table>";
      tableDiv.innerHTML = html;
    }

    // ===== Save attendance =====
    saveBtn.addEventListener('click', () => {
      const checked = [...document.querySelectorAll('.absent:checked')].map(cb => cb.value);
      const year = yearSel.value;
      const today = new Date().toISOString().slice(0,10);

      statusDiv.innerHTML = "Saving attendance...";
      fetch(`${SCRIPT_URL}?action=saveAttendance&dept=${dept}&year=${year}&date=${today}&absentees=${checked.join(",")}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            statusDiv.innerHTML = "✅ Attendance saved. Checking leave requests...";
            getLeaves(year, today, checked);
          } else {
            statusDiv.innerHTML = "Error saving: " + data.message;
          }
        })
        .catch(err => statusDiv.innerHTML = "Error: " + err);
    });

    // ===== Get leave requests and compare =====
    function getLeaves(year, date, absentees) {
      fetch(`${SCRIPT_URL}?action=getLeaveRequests&dept=${dept}&date=${date}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            const leaves = data.leaves.map(l => l.rollno);
            let html = "<h3>Absentees:</h3><ul>";
            absentees.forEach(roll => {
              if (leaves.includes(roll)) {
                html += `<li class="leave">${roll} ✔️ (Leave Applied)</li>`;
              } else {
                html += `<li class="no-leave">${roll} ❌ (No Leave)</li>`;
              }
            });
            html += "</ul>";
            tableDiv.insertAdjacentHTML('beforeend', html);
            statusDiv.innerHTML = "";
          } else {
            statusDiv.innerHTML = "Could not fetch leave data";
          }
        });
    }
  </script>
</body>
</html>
